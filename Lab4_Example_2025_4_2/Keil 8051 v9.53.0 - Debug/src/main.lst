C51 COMPILER V9.60.0.0   MAIN                                                              01/02/2026 12:00:05 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\src/main.OBJ
COMPILER INVOKED BY: Z:\home\onachman\SimplicityStudio5\SimplicityStudio_v5\developer\toolchains\keil_8051\9.60\BIN\C51 
                    -/home/onachman/SimplicityStudio/v5_workspace/Lab4_Example_2025_4_2/src/main.c OMF2 SMALL DEBUG OBJECTEXTEND ROM(LARGE) W
                    -ARNINGLEVEL(2) FLOATFUZZY(3) OPTIMIZE(8,SPEED) INTVECTOR(0X0000) INTPROMOTE INCDIR(/home/onachman/SimplicityStudio/v5_wo
                    -rkspace/Lab4_Example_2025_4_2/inc;/home/onachman/SimplicityStudio/v5_workspace/Lab4_Example_2025_4_2/inc/config;/home/on
                    -achman/SimplicityStudio5/SimplicityStudio_v5/developer/sdks/8051/v4.3.1//kits/common/drivers/efm8_memory_lcd/inc;/home/o
                    -nachman/SimplicityStudio5/SimplicityStudio_v5/developer/sdks/8051/v4.3.1//kits/common/drivers/efm8_memory_lcd/inc/graphi
                    -cs;/home/onachman/SimplicityStudio5/SimplicityStudio_v5/developer/sdks/8051/v4.3.1//kits/common/drivers/efm8_memory_lcd/
                    -inc/config;/home/onachman/SimplicityStudio5/SimplicityStudio_v5/developer/sdks/8051/v4.3.1//kits/common/bsp;/home/onachm
                    -an/SimplicityStudio5/SimplicityStudio_v5/developer/sdks/8051/v4.3.1//kits/EFM8UB2_SLSTK2001A/config;/home/onachman/Simpl
                    -icityStudio5/SimplicityStudio_v5/developer/sdks/8051/v4.3.1//Device/shared/si8051Base;/home/onachman/SimplicityStudio5/S
                    -implicityStudio_v5/developer/sdks/8051/v4.3.1//Device/EFM8UB2/inc;/home/onachman/SimplicityStudio5/SimplicityStudio_v5/d
                    -eveloper/sdks/8051/v4.3.1//kits/common/drivers/efm8_joystick;/home/onachman/SimplicityStudio5/SimplicityStudio_v5/develo
                    -per/sdks/8051/v4.3.1//kits/common/drivers/efm8_rgb_led;/home/onachman/SimplicityStudio5/SimplicityStudio_v5/developer/sd
                    -ks/8051/v4.3.1//Device/EFM8UB2/peripheral_driver/inc) PRINT(.\src/main.lst) COND PAGEWIDTH(120) PAGELENGTH(65) OBJECT(.\
                    -src/main.OBJ)

line level    source

   1          #include <SI_EFM8UB2_Register_Enums.h>
   2          #include "InitDevice.h"
   3          #include "tick.h"
   4          #include <stdint.h>
   5          
   6          // ===== Joystick driver =====
   7          // ×‘×¨×•×‘ ×”×ž×¢×‘×“×•×ª ×–×” ××—×“ ×ž×”×‘××™×. ×ª×©××™×¨ ×¨×§ ××ª ×”-include ×”×–×”:
   8          #include "joystick.h"
   9          
  10          // ------------------------------------------------------------
  11          // CONFIG: choose joystick function name (×¨×§ ×× ×¢×“×™×™×Ÿ ×™×© WARNING/ERROR)
  12          // ------------------------------------------------------------
  13          // ×× ××ª×” ×ž×§×‘×œ WARNING ×©×œ "missing function-prototype" ××• ERROR ×©×œ undefined symbol,
  14          // ××– ×ª×‘×—×¨ ×¤×” × ×›×•×Ÿ ×œ×¤×™ ×ž×” ×©×™×© ××¦×œ×š ×‘-joystick.h
  15          //
  16          // ××•×¤×¦×™×” A (× ×¤×•×¥):
  17          uint8_t JOYSTICK_getDirection(void);
  18          // ××•×¤×¦×™×” B (×× ××¦×œ×š ×”×¤×•× ×§×¦×™×” × ×§×¨××ª ××—×¨×ª) â€” ××– ×ª×—×œ×™×£ ××ª ×”×©×•×¨×”
             - ×ž×¢×œ ×œ×–×”:
  19          // uint8_t JOYSTICK_directionGet(void);
  20          // ×•×ª×¢×“×›×Ÿ ×’× ×œ×ž×˜×” ×‘×©×•×¨×” ×©×œ JOY_READ_DIR()
  21          
  22          // ×ž××§×¨×• ×œ×§×¨×™××” ××—×™×“×”:
  23          #define JOY_READ_DIR()   (JOYSTICK_getDirection())
  24          // ×× ××ª×” ×¢×•×‘×¨ ×œ××•×¤×¦×™×” B:
  25          // #define JOY_READ_DIR()   (JOYSTICK_directionGet())
  26          
  27          // ------------------------------------------------------------
  28          // Direction mapping (×ž×›×¡×” ×©×ž×•×ª ×©×•× ×™× ×©×œ ×”×“×¨×™×™×‘×¨)
  29          // ------------------------------------------------------------
  30          #if defined(JOYSTICK_E)
  31            #define JOY_RIGHT   JOYSTICK_E
  32          #elif defined(JOYSTICK_EAST)
                #define JOY_RIGHT   JOYSTICK_EAST
              #elif defined(JOYSTICK_DIR_E)
                #define JOY_RIGHT   JOYSTICK_DIR_E
              #elif defined(JOYSTICK_DIR_EAST)
                #define JOY_RIGHT   JOYSTICK_DIR_EAST
              #else
                #define JOY_RIGHT   0xFF   // ×× ×œ× × ×ž×¦×, ×œ× ×™×¢×‘×•×“ ×¢×“ ×©×ª×ª×§×Ÿ ×œ×¤×™ ×”-header
              #endif
  41          
C51 COMPILER V9.60.0.0   MAIN                                                              01/02/2026 12:00:05 PAGE 2   

  42          #if defined(JOYSTICK_W)
  43            #define JOY_LEFT    JOYSTICK_W
  44          #elif defined(JOYSTICK_WEST)
                #define JOY_LEFT    JOYSTICK_WEST
              #elif defined(JOYSTICK_DIR_W)
                #define JOY_LEFT    JOYSTICK_DIR_W
              #elif defined(JOYSTICK_DIR_WEST)
                #define JOY_LEFT    JOYSTICK_DIR_WEST
              #else
                #define JOY_LEFT    0xFE
              #endif
  53          
  54          // ------------------------------------------------------------
  55          // User settings
  56          // ------------------------------------------------------------
  57          #define DUTY_STEP        5     // ×›×ž×” ×›×œ "×§×œ×™×§" ×’'×•×™×¡×˜×™×§ ×ž×©× ×” ×ž×”×™×¨×•×ª (%)
  58          #define DUTY_START       30    // ×ž×”×™×¨×•×ª ×”×ª×—×œ×ª×™×ª (%)
  59          #define JOY_DELAY_MS     120   // ×›×“×™ ×©×œ× ×™×”×™×” ×ž×”×™×¨ ×ž×“×™
  60          #define BTN_DEBOUNCE_MS  250
  61          #define DIR_SWITCH_PAUSE 50    // ×¢×¦×™×¨×” ×§×˜× ×” ×œ×¤× ×™ ×”×—×œ×¤×ª ×›×™×•×•×Ÿ
  62          
  63          // ------------------------------------------------------------
  64          // Buttons (×œ×¤×™ ×”×œ×•×— ×©×œ×›×)
  65          SI_SBIT(BTN0, SFR_P0, 2);
  66          SI_SBIT(BTN1, SFR_P0, 3);
  67          
  68          // Motor direction pins (×œ×¤×™ ×ž×¦×’×ª 8: P0.4,P0.5)
  69          SI_SBIT(M1, SFR_P0, 4);   // -> L293D IN1 (Pin 2)
  70          SI_SBIT(M2, SFR_P0, 5);   // -> L293D IN2 (Pin 7)
  71          
  72          typedef enum { DIR_RIGHT = 0, DIR_LEFT = 1 } motor_dir_t;
  73          
  74          // ------------------------------------------------------------
  75          // Motor direction control
  76          // ------------------------------------------------------------
  77          static void Motor_SetDir(motor_dir_t dir)
  78          {
  79   1          if (dir == DIR_RIGHT) { M1 = 1; M2 = 0; }
  80   1          else                  { M1 = 0; M2 = 1; }
  81   1      }
  82          
  83          // ------------------------------------------------------------
  84          // PWM control (PCA module 0, 8-bit PWM)
  85          // note: duty% -> PCA0CPH0 mapping
  86          // ------------------------------------------------------------
  87          static void PWM_SetDuty_0_100(uint8_t duty_percent)
  88          {
  89   1          uint16_t cp;
  90   1      
  91   1          if (duty_percent > 100) duty_percent = 100;
  92   1      
  93   1          // 100% => 0, 0% => 255
  94   1          cp = 256 - ((uint16_t)duty_percent * 256) / 100;
  95   1          if (cp > 255) cp = 255;
  96   1      
  97   1          PCA0CPH0 = (uint8_t)cp;
  98   1      }
  99          
 100          void main(void)
 101          {
 102   1          motor_dir_t dir;
 103   1          uint8_t duty;
 104   1          uint8_t jdir;
C51 COMPILER V9.60.0.0   MAIN                                                              01/02/2026 12:00:05 PAGE 3   

 105   1      
 106   1          enter_DefaultMode_from_RESET();
 107   1          IE_EA = 1;
 108   1      
 109   1          // P0.4,P0.5 output push-pull (×›×™×•×•×Ÿ)
 110   1          P0MDOUT |= (1<<4) | (1<<5);
 111   1      
 112   1          // PCA PWM on module 0:
 113   1          // ECOM=1 + PWM=1 -> 0x42
 114   1          PCA0CPM0 = 0x42;
 115   1      
 116   1          // Start PCA counter
 117   1          PCA0CN0_CR = 1;
 118   1      
 119   1          // init state
 120   1          dir = DIR_RIGHT;
 121   1          duty = DUTY_START;
 122   1      
 123   1          Motor_SetDir(dir);
 124   1          PWM_SetDuty_0_100(duty);
 125   1      
 126   1          while (1)
 127   1          {
 128   2              // ---------------- Buttons: direction ----------------
 129   2              if (BTN0 == 0) {
 130   3                  PWM_SetDuty_0_100(0);
 131   3                  Wait(DIR_SWITCH_PAUSE);
 132   3      
 133   3                  dir = DIR_RIGHT;
 134   3                  Motor_SetDir(dir);
 135   3      
 136   3                  PWM_SetDuty_0_100(duty);
 137   3                  Wait(BTN_DEBOUNCE_MS);
 138   3              }
 139   2      
 140   2              if (BTN1 == 0) {
 141   3                  PWM_SetDuty_0_100(0);
 142   3                  Wait(DIR_SWITCH_PAUSE);
 143   3      
 144   3                  dir = DIR_LEFT;
 145   3                  Motor_SetDir(dir);
 146   3      
 147   3                  PWM_SetDuty_0_100(duty);
 148   3                  Wait(BTN_DEBOUNCE_MS);
 149   3              }
 150   2      
 151   2              // ---------------- Joystick: speed ----------------
 152   2              jdir = JOY_READ_DIR();
 153   2      
 154   2              // ×× JOY_RIGHT/JOY_LEFT ×œ× ×–×•×”×• (× ×©××¨×• 0xFF/0xFE),
 155   2              // ×–×” ××•×ž×¨ ×©×”×©×ž×•×ª ××¦×œ×š ×©×•× ×™× -> ×¦×¨×™×š ×œ×”×¡×ª×›×œ ×‘-joystick.h ×•×œ×”×•×
             -¡×™×£ ×œ×ž×™×¤×•×™ ×œ×ž×¢×œ×”.
 156   2              if (jdir == JOY_RIGHT) {
 157   3                  if (duty + DUTY_STEP <= 100) duty += DUTY_STEP;
 158   3                  PWM_SetDuty_0_100(duty);
 159   3                  Wait(JOY_DELAY_MS);
 160   3              }
 161   2              else if (jdir == JOY_LEFT) {
 162   3                  if (duty >= DUTY_STEP) duty -= DUTY_STEP;
 163   3                  PWM_SetDuty_0_100(duty);
 164   3                  Wait(JOY_DELAY_MS);
 165   3              }
 166   2          }
C51 COMPILER V9.60.0.0   MAIN                                                              01/02/2026 12:00:05 PAGE 4   

 167   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    230    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
