/*
 * -------------------------------------------------------------------------------------
 * – Так что же? Разве несовершенно само искусство врачевания?
 *
 * Бывает ли вообще нужно дополнять любое искусство еще каким-нибудь положительным
 * качеством, как глаза – зрением, а уши – слухом? Нужно ли поэтому к любому
 * искусству добавлять еще какое-нибудь другое искусство, которое решало бы,
 * что пригодно для первого и чем его надо восполнить?
 *
 * Разве в самом искусстве скрыто какое-то несовершенство и любое искусство
 * нуждается еще в другом искусстве, которое обсуждало бы, что полезно тому,
 * первому? А для этого обсуждающего искусства необходимо в свою очередь еще
 * другое подобного же рода искусство и так до бесконечности?
 *
 * Или же всякое искусство само по себе решает, что для него пригодно? Или же для
 * обсуждения того, что исправит его недостатки, ему не требуется ни самого себя,
 * ни другого искусства? Ведь у искусства не бывает никакого несовершенства или
 * погрешности и ему не годится изыскивать пригодное за пределами себя самого.
 *
 * Раз оно правильно, в нем нет ущерба и искажений, пока оно сохраняет свою
 * безупречность и целостность. Рассмотри это в точном, установленном тобой
 * смысле слова – так это будет или по-другому?
 * -------------------------------------------------------------------------------------
 */
#include <SI_EFM8UB2_Register_Enums.h>
#include "InitDevice.h"

// Buttons
SI_SBIT(PB0, SFR_P0, 2); // Button Left
SI_SBIT(PB1, SFR_P0, 3); // Button Right

// PWM Values for SG90 Servo (Extended Range: 0.6ms - 2.4ms)
// PCA Clock = 4MHz. Formula: 65536 - (Time_us / 0.25)
#define SERVO_POS_0   63136  // ~0 degrees
#define SERVO_POS_90  59536  // 90 degrees (Center)
#define SERVO_POS_180 55936  // ~180 degrees

//-----------------------------------------------------------------------------
// Function Prototypes
//-----------------------------------------------------------------------------
void SiLabs_Startup(void);
void Set_Servo_PWM(uint16_t val);
void Delay_ms(uint16_t ms);

//-----------------------------------------------------------------------------
// SiLabs_Startup (Required to disable Watchdog)
//-----------------------------------------------------------------------------
void SiLabs_Startup (void)
{
    PCA0MD &= ~0x40; // Disable WDT
}

//-----------------------------------------------------------------------------
// Helper Functions
//-----------------------------------------------------------------------------
void Set_Servo_PWM(uint16_t val)
{
    PCA0CPL0 = (val & 0x00FF);
    PCA0CPH0 = (val >> 8);
}

void Delay_ms(uint16_t ms)
{
    uint16_t i;
    volatile uint16_t j;
    for(i = 0; i < ms; i++)
    {
        for(j = 0; j < 4000; j++);
    }
}

//-----------------------------------------------------------------------------
// Main Loop
//-----------------------------------------------------------------------------
void main (void)
{
    enter_DefaultMode_from_RESET();

    // Force Settings
    XBR1 |= 0x40;    // Enable Crossbar
    PCA0CPM0 = 0xC2; // Enable 16-bit PWM
    IE_EA = 1;       // Enable Interrupts

    // Start at Center
    Set_Servo_PWM(SERVO_POS_90);
    Delay_ms(500);

    while (1)
    {
        // 1. Check BOTH buttons (Priority: Return to Center)
        if ((PB0 == 0) && (PB1 == 0))
        {
            Set_Servo_PWM(SERVO_POS_90);
            Delay_ms(50);
        }
        // 2. Check Button 0 (Move Left)
        else if (PB0 == 0)
        {
            Set_Servo_PWM(SERVO_POS_0);
        }
        // 3. Check Button 1 (Move Right)
        else if (PB1 == 0)
        {
            Set_Servo_PWM(SERVO_POS_180);
        }

        Delay_ms(20);
    }
}
